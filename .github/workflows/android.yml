name: Qt Android CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Qt
      run: |
        sudo pip install aqtinstall
        aqt install-qt linux android 5.15.2 -O "$HOME/Qt" \
          --archives qtbase qttools qtdoc qtdeclarative

    - name: Setup Android SDK
      run: |
        export ANDROID_SDK_ROOT="$HOME/android-sdk"
        mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
        
        wget https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip
        unzip commandlinetools-linux-*.zip -d temp
        mv temp/cmdline-tools/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
        rm -rf temp
        
        echo "JAVA_HOME=$JAVA_HOME_17_X64" >> $GITHUB_ENV
        echo "$JAVA_HOME_17_X64/bin" >> $GITHUB_PATH
        
        yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
        "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" "platform-tools" "platforms;android-33" "build-tools;33.0.0"

    - name: Install Android NDK
      run: |
        # 关键修改：安装到用户目录避免权限问题
        mkdir -p "$HOME/android-ndk"
        wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip android-ndk-r25c-linux.zip -d "$HOME/android-ndk"
        
        # 设置环境变量指向新路径
        NDK_PATH="$HOME/android-ndk/android-ndk-r25c"
        echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
        echo "$NDK_PATH" >> $GITHUB_PATH
        
        # 验证安装
        ls -l $NDK_PATH

    - name: Configure environment
      run: |
        echo "$HOME/Qt/5.15.2/android/bin" >> $GITHUB_PATH
        echo "QT_DIR=$HOME/Qt/5.15.2/android" >> $GITHUB_ENV

    - name: Build project
      run: |
        qmake -spec android-clang \
          "ANDROID_ABIS=armeabi-v7a arm64-v8a" \
          CONFIG+=release
        make -j$(nproc)
        make apk

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: android-build/*release.apk
