name: Qt Android Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  QT_VERSION: 5.15.2
  QT_FULL_VERSION: 5.15.2  # 使用标准版本格式
  JDK_VERSION: 17
  ANDROID_NDK_VERSION: 21.3.6528147  # Qt官方验证的NDK版本
  ANDROID_SDK_VERSION: 6858149

jobs:
  build:
    name: Build Android APK
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JDK_VERSION }}
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JDK_VERSION }}
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      with:
        ndk-version: ${{ env.ANDROID_NDK_VERSION }}
        sdk-version: ${{ env.ANDROID_SDK_VERSION }}

    - name: Install Qt (Android)
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_FULL_VERSION }}
        host: windows
        target: android
        arch: android_arm64_v8a  # 正确架构名称
        modules: qtcharts  # 基础模块的特殊写法
        extra: "--autodesktop"  # 自动安装必要依赖

    - name: List Installed Modules
      shell: cmd
      run: dir C:\Qt\${{ env.QT_FULL_VERSION }}\android_arm64_v8a

    - name: Setup Build Environment
      shell: cmd
      run: |
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        echo "ANDROID_SDK_ROOT=$env:ANDROID_SDK_ROOT" >> $env:GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$env:ANDROID_NDK_ROOT" >> $env:GITHUB_ENV
        echo "JAVA_HOME=$env:JAVA_HOME" >> $env:GITHUB_ENV
        echo "QT_DIR=C:\Qt\${{ env.QT_FULL_VERSION }}\android_arm64_v8a" >> $env:GITHUB_ENV
        echo "PATH=$env:QT_DIR\bin;$env:PATH" >> $env:GITHUB_ENV

    - name: Build APK
      shell: cmd
      run: |
        qmake -spec android-clang "CONFIG+=release" Knot.pro
        jom install INSTALL_ROOT=android-build
        androiddeployqt --gradle --release --input android-libKnot.so-deployment-settings.json --output android-build

    - name: Sign APK
      shell: cmd
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 -keystore ${{ secrets.KEYSTORE_PATH }} -storepass %KEYSTORE_PASSWORD% -keypass %KEY_PASSWORD% android-build\build\outputs\apk\release\*.apk %KEY_ALIAS%
        zipalign -v 4 android-build\build\outputs\apk\release\*.apk Knot-Signed.apk

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Android-APK
        path: |
          Knot-Signed.apk
          android-build/build/outputs/apk/release/*.apk
