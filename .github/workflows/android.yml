# 文件名: .github/workflows/android-qt.yml
name: Android Qt Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  QT_VERSION: "6.7.0"           # 使用的Qt版本
  ANDROID_API: 33               # Android API Level
  BUILD_DIR: "android-build"    # 构建目录
  NDK_VERSION: "25.1.8937393"   # NDK版本

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 40

    steps:
    # ----------------------------------
    # 1. 代码检出
    # ----------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # ----------------------------------
    # 2. 安装Qt环境
    # ----------------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Qt with mirror
      run: |
        pip install aqtinstall==3.1.9
        aqt config --base-url https://mirrors.ustc.edu.cn/qtproject
        aqt install-qt linux android ${{ env.QT_VERSION }} \
          --outputdir /opt/qt \
          arm64_v8a \
          -m qtbase qtmqtt qtquick3d

    # ----------------------------------
    # 3. 配置Android环境
    # ----------------------------------
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      with:
        ndk-version: ${{ env.NDK_VERSION }}
        sdk-platform: android-${{ env.ANDROID_API }}
        sdk-build-tools: "34.0.0"

    # ----------------------------------
    # 4. 环境变量配置
    # ----------------------------------
    - name: Set environment variables
      shell: bash
      run: |
        echo "QT_ROOT=/opt/qt/${{ env.QT_VERSION }}/android_arm64_v8a" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        echo "PATH=$QT_ROOT/bin:$PATH" >> $GITHUB_ENV

    # ----------------------------------
    # 5. 项目构建
    # ----------------------------------
    - name: Configure project
      working-directory: ./android  # 如果项目在子目录需要修改
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        qt-cmake .. \
          -DCMAKE_SYSTEM_NAME=Android \
          -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
          -DCMAKE_ANDROID_NDK=$ANDROID_NDK_ROOT

    - name: Build project
      working-directory: ./android/${{ env.BUILD_DIR }}
      run: cmake --build . --parallel 4

    # ----------------------------------
    # 6. 生成APK
    # ----------------------------------
    - name: Package APK
      working-directory: ./android/${{ env.BUILD_DIR }}
      run: |
        androiddeployqt \
          --input android-libKnot-deployment-settings.json \
          --output android-output \
          --gradle \
          --verbose

    # ----------------------------------
    # 7. 上传产物
    # ----------------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: |
          android/${{ env.BUILD_DIR }}/android-output/build/outputs/apk/debug/*.apk
          android/${{ env.BUILD_DIR }}/android-output/build/outputs/apk/release/*.apk

    # ----------------------------------
    # 8. 缓存优化 (可选)
    # ----------------------------------
    - name: Cache Qt
      uses: actions/cache@v3
      with:
        path: /opt/qt
        key: qt-${{ env.QT_VERSION }}-android-arm64

    - name: Cache Android SDK
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.ANDROID_SDK_ROOT }}
          ${{ env.ANDROID_NDK_ROOT }}
        key: android-sdk-${{ runner.os }}
