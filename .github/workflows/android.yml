name: Android Build with JDK17

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  QT_VERSION: 5.15.2
  ANDROID_API: 33
  ANDROID_BUILD_TOOLS: 33.0.0
  ANDROID_NDK: 21.4.7075529

jobs:
  build-android:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Android SDK
      uses: android-actions/setup-android@v2
      with:
        ndk-version: ${{ env.ANDROID_NDK }}
        build-tools-version: ${{ env.ANDROID_BUILD_TOOLS }}
        platform-version: android-${{ env.ANDROID_API }}

    - name: Install Qt with JDK17 workaround
      run: |
        sudo apt-get install -y libgl1-mesa-dev
        pip3 install aqtinstall
        aqt install-qt linux android ${{ env.QT_VERSION }} android_arm64_v8a \
          -m qtcharts qtsvg qtquickcontrols2 qtgraphicaleffects \
          --autodesktop

    - name: Configure Gradle for JDK17
      run: |
        echo "org.gradle.java.home=$JAVA_HOME" > gradle.properties
        echo "android.builder.sdkDownload=true" >> gradle.properties

    - name: Build project
      run: |
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export ANDROID_NDK_HOME=$ANDROID_NDK_ROOT
        export PATH=$HOME/Qt/$QT_VERSION/android_arm64_v8a/bin:$PATH
        
        qmake Knot.pro -spec android-clang \
          CONFIG+=release \
          ANDROID_ABIS=arm64-v8a \
          "QMAKE_JAVAC=javac -J-Dfile.encoding=UTF-8"
        
        make -j$(nproc)
        make apk

    - name: Fix Gradle compatibility
      run: |
        sed -i 's/gradle:6.5.1/gradle:7.5.1/' android-build/build.gradle
        sed -i 's/jcenter()/mavenCentral()/g' android-build/build.gradle

    - name: Generate Signed APK
      run: |
        cd android-build
        $HOME/Qt/$QT_VERSION/android_arm64_v8a/bin/androiddeployqt \
          --input android-libKnot.so-deployment-settings.json \
          --output android-build \
          --gradle -- --no-daemon -Pandroid.injected.signing.store.file=../android/release.keystore \
          -Pandroid.injected.signing.store.password=${{ secrets.STORE_PASSWORD }} \
          -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
          -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}

    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: Knot-Android-APK
        path: |
          android-build/build/outputs/apk/release/*-release.apk
          android-build/build/outputs/apk/debug/*-debug.apk
