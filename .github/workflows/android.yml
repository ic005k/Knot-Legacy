name: Android CI with Secure Signing

on: [push]

env:
  QT_VERSION: '6.7.0'
  ANDROID_ARCH: 'android_arm64_v8a'

jobs:
  build:
    name: Build and Sign
    runs-on: windows-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # 密钥库解码 (安全处理)
    - name: Prepare Keystore
      shell: pwsh
      run: |
        $keystorePath = "release_${env:GITHUB_RUN_NUMBER}.jks"
        [Convert]::FromBase64String("${{ secrets.ANDROID_KEYSTORE_B64 }}") | Set-Content $keystorePath -Encoding Byte
        echo "KEYSTORE_PATH=$keystorePath" >> $env:GITHUB_ENV
      env:
        ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE }}

    # 安卓环境
    - name: Setup Android
      uses: android-actions/setup-android@v2
      with:
        ndk-version: '27.2.12479018'
        sdk-platform: 'android-34'

    # Qt安装
    - name: Install Qt
      run: |
        python -m pip install aqtinstall
        aqt install-qt windows android ${{ env.QT_VERSION }} ${{ env.ANDROID_ARCH }}
        aqt install-tool windows desktop tools_mingw

    # 构建签名
    - name: Build with Signing
      shell: pwsh
      run: |
        $qtBin = "C:\Qt\${{ env.QT_VERSION }}\${{ env.ANDROID_ARCH }}\bin"
        
        # 生成Makefile
        & "$qtBin\qmake" -spec android-clang "CONFIG += release" Knot.pro
        
        # 编译
        jom -j 8 install INSTALL_ROOT=android-build
        
        # 签名部署
        & "$qtBin\androiddeployqt" `
          --gradle `
          --release `
          --input android-libKnot.so-deployment-settings.json `
          --output android-build `
          --sign "$env:KEYSTORE_PATH" `
          --storepass "${{ secrets.KEYSTORE_PASSWORD }}" `
          --alias "${{ secrets.KEY_ALIAS }}" `
          --keypass "${{ secrets.KEY_PASSWORD }}"

    # 上传产物 (修复v3到v4版本问题)
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: signed-apk
        path: |
          android-build/build/outputs/apk/release/*.apk
        retention-days: 3

    # 安全清理
    - name: Clean Keystore
      if: always()
      shell: pwsh
      run: Remove-Item -Path $env:KEYSTORE_PATH -Force
