name: Android Qt Build

on:
  push:
    branches: [ main ]

env:
  QT_VERSION: "6.7.0"
  ANDROID_API: 33
  NDK_VERSION: "25.1.8937393"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 40

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # 使用官方源的标准安装方式
    - name: Install Qt
      run: |
        pip install aqtinstall==3.2.0
        aqt install-qt linux android $QT_VERSION \
          --outputdir /opt/qt \
          android_arm64_v8a \
          -m qtbase qtsvg qtdeclarative

    - name: Setup Android
      uses: android-actions/setup-android@v2
      with:
        ndk-version: ${{ env.NDK_VERSION }}
        sdk-platform: android-${{ env.ANDROID_API }}

    - name: Build with qmake
      run: |
        export PATH="/opt/qt/$QT_VERSION/android_arm64_v8a/bin:$PATH"
        qmake Knot.pro -spec android-clang \
          ANDROID_ABIS=arm64-v8a \
          ANDROID_MIN_SDK_VERSION=$ANDROID_API
        
        make -j4
        androiddeployqt --input android-Knot-deployment-settings.json --output build --gradle

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: knot-apk
        path: build/build/outputs/apk/debug/*.apk
