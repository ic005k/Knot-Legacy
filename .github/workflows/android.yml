name: Android Qt Build

on:
  push:
    branches: [ main ]

env:
  QT_VERSION: "6.7.0"
  ANDROID_API: 33

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 40

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Qt dependencies
      run: |
        sudo apt-get -qq install libgl1-mesa-dev

    - name: Install Qt (correct syntax)
      run: |
        pip install aqtinstall==3.2.0
        aqt install-qt linux android ${{ env.QT_VERSION }} \
          --outputdir /opt/qt \
          --architectures android_arm64_v8a \
          -m qtbase qtsvg

    - name: Setup Android NDK
      uses: android-actions/setup-android@v2
      with:
        ndk-version: 25.1.8937393
        sdk-platform: android-${{ env.ANDROID_API }}

    - name: Configure build environment
      shell: bash
      run: |
        echo "QT_DIR=/opt/qt/${{ env.QT_VERSION }}/android_arm64_v8a" >> $GITHUB_ENV
        echo "PATH=$QT_DIR/bin:$PATH" >> $GITHUB_ENV

    - name: Build project
      run: |
        qmake Knot.pro -spec android-clang \
          "ANDROID_ABIS=arm64-v8a" \
          "ANDROID_MIN_SDK_VERSION=$ANDROID_API"
        make -j4
        androiddeployqt --input android-Knot-deployment-settings.json --output build

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-app
        path: build/build/outputs/apk/debug/*.apk
