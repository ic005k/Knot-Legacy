name: Android Qt Build (64-bit)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  QT_VERSION: 5.15.13
  ANDROID_API: android-33
  NDK_VERSION: 25.2.9519653
  QT_HOST: linux
  QT_TARGET: android
  QT_ARCH: android_arm64_v8a

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev ninja-build

    - name: Install aqtinstall
      run: pip install aqtinstall==3.1.11

    - name: Install Qt and Android components
      run: |
        aqt install-qt ${{ env.QT_HOST }} ${{ env.QT_TARGET }} ${{ env.QT_VERSION }} ${{ env.QT_ARCH }} \
          -m qtbase qtsvg qtdeclarative qtquickcontrols2 qtgraphicaleffects qtmacextras qttools \
          --autodesktop \
          --outputdir /opt/qt

        aqt install-sdk --rootdir /opt/android-sdk ${{ env.QT_HOST }} ${{ env.QT_TARGET }} \
          tools platform-tools platform:${{ env.ANDROID_API }} ndk:${{ env.NDK_VERSION }} build-tools:34.0.0

    - name: Setup environment
      run: |
        echo "ANDROID_SDK_ROOT=/opt/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=/opt/android-sdk/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
        echo "PATH=$PATH:/opt/qt/${{ env.QT_VERSION }}/android_arm64_v8a/bin" >> $GITHUB_ENV

    - name: Generate debug keystore
      if: github.event_name == 'push'
      run: |
        keytool -genkey -v -keystore debug.keystore \
          -storepass android -alias androiddebugkey \
          -keypass android -dname "CN=, OU=, O=, L=, S=, C=" \
          -keyalg RSA -keysize 2048 -validity 10000

    - name: Build project
      run: |
        mkdir build
        cd build
        qmake ../Knot.pro -spec android-clang CONFIG+=release ANDROID_ABIS=arm64-v8a
        make -j4
        make apk

    - name: Sign APK
      env:
        RELEASE_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        KEYSTORE_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASS: ${{ secrets.KEY_PASSWORD }}
      run: |
        if [ -n "$RELEASE_KEYSTORE" ]; then
          echo "Signing with release keystore"
          echo "$RELEASE_KEYSTORE" | base64 -d > release.keystore
          cd build/android-build/build/outputs/apk/release/
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore ../../../../../../release.keystore \
            -storepass "$KEYSTORE_PASS" \
            -keypass "$KEY_PASS" \
            android-build-release-unsigned.apk \
            "$KEY_ALIAS"
          
          $ANDROID_SDK_ROOT/build-tools/34.0.0/zipalign -v 4 android-build-release-unsigned.apk Knot-signed.apk
        else
          echo "Signing with debug keystore"
          cd build/android-build/build/outputs/apk/release/
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore ../../../../../../debug.keystore \
            -storepass android \
            -keypass android \
            android-build-release-unsigned.apk \
            androiddebugkey
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: Android-64-APK
        path: |
          build/android-build/build/outputs/apk/release/*-signed.apk
          build/android-build/build/outputs/apk/release/android-build-release-unsigned.apk
