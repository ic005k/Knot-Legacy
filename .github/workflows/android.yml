name: Android Qt CI

on: [push]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # 使用Python 3.10+环境
    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 安装兼容版本的aqtinstall
    - name: Install Qt Tools
      run: |
        python -m pip install "aqtinstall<3.2.0"
        aqt install-qt windows android 6.7.0 android_arm64_v8a --autodesktop

    # 配置NDK路径
    - name: Setup Android NDK
      uses: android-actions/setup-android@v2
      with:
        ndk-version: '27.2.12479018'

    # 构建步骤
    - name: Build Project
      shell: pwsh
      env:
        QTDIR: C:\Qt\6.7.0\android_arm64_v8a
        ANDROID_NDK_ROOT: ${{ env.ANDROID_NDK_ROOT }}
      run: |
        # 验证工具链
        Get-Command qmake
        Get-Command clang++

        # 生成构建文件
        qmake -spec android-clang "CONFIG += release" Knot.pro
        
        # 使用ninja替代jom
        cmake --build . --parallel 8

    # 产物上传
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: |
          android-build/outputs/apk/*.apk
