name: Android Qt CI Fix

on: [push]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 25

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 使用Python 3.10
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 修复安装命令语法
    - name: Install Qt with Correct Syntax
      shell: pwsh
      run: |
        python -m pip install "aqtinstall==3.1.0"
        aqt install-qt windows android 6.7.0 android_arm64_v8a `
          --outputdir "C:\Qt" `
          --autodesktop `
          -m qtcharts qtmqtt

    # 验证安装路径
    - name: Verify Qt Installation
      shell: pwsh
      run: |
        if (Test-Path "C:\Qt\6.7.0\android_arm64_v8a\bin\qmake.exe") {
            echo "Qt安装验证成功"
            Get-ChildItem "C:\Qt\6.7.0\android_arm64_v8a\bin"
        } else {
            Write-Error "Qt安装失败"
            exit 1
        }

    # 配置环境变量
    - name: Set Environment Variables
      run: |
        echo "QTDIR=C:\Qt\6.7.0\android_arm64_v8a" >> $env:GITHUB_ENV
        echo "PATH=$env:PATH;C:\Qt\6.7.0\android_arm64_v8a\bin" >> $env:GITHUB_ENV

    # 构建步骤
    - name: Build Project
      shell: pwsh
      run: |
        qmake -spec android-clang "CONFIG += release" Knot.pro
        jom -j 8
        androiddeployqt --gradle --release --input android-libKnot.so-deployment-settings.json

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-app
        path: android-build/build/outputs/apk/release/*.apk
