name: Android Build

on:
  push:
    branches:
      - main  # 根据实际情况修改分支名称

jobs:
  build-android:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          target: 'android'
          arch: 'android_armv7'  # 根据实际需求选择架构

      - name: Set up Android SDK
        uses: android-actions/setup-android@v2

      - name: Configure Qt project
        run: |
          qmake -spec android-clang "CONFIG+=qtquickcompiler" Knot.pro
        shell: cmd

      - name: Build project
        run: |
          nmake
        shell: cmd

      - name: Sign APK
        env:
          KEYSTORE_PATH: 'your_keystore.jks'  # 替换为你的密钥库路径
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}  # 在 GitHub 仓库的 Secrets 中设置
          KEY_ALIAS: 'your_key_alias'  # 替换为你的密钥别名
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}  # 在 GitHub 仓库的 Secrets 中设置
          APK_PATH: 'path/to/your/app-debug.apk'  # 替换为生成的 APK 路径
        run: |
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 -keystore %KEYSTORE_PATH% -storepass %KEYSTORE_PASSWORD% -keypass %KEY_PASSWORD% %APK_PATH% %KEY_ALIAS%
        shell: cmd

      - name: Align APK
        env:
          APK_PATH: 'path/to/your/app-debug.apk'  # 替换为生成的 APK 路径
          ALIGNED_APK_PATH: 'path/to/your/app-debug-aligned.apk'  # 替换为对齐后的 APK 路径
        run: |
          zipalign -v 4 %APK_PATH% %ALIGNED_APK_PATH%
        shell: cmd

      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: android-apk
          path: path/to/your/app-debug-aligned.apk  # 替换为对齐后的 APK 路径
