name: Android Qt CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  QT_VERSION: 5.15.2
  QT_HOST: linux
  QT_TARGET: android
  QT_ARCH: android_arm64_v8a
  ANDROID_API: 31
  BUILD_TOOLS: "33.0.0"
  NDK_VERSION: 25.1.8937393

jobs:
  build-android:
    name: Qt Android Build
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: ${{ env.ANDROID_API }}
        build-tools: ${{ env.BUILD_TOOLS }}

    - name: Install Qt with aqt
      run: |
        # 使用国内镜像加速
        pip install aqtinstall -i https://pypi.tuna.tsinghua.edu.cn/simple
        
        # 安装基础模块
        aqt install-qt $QT_HOST $QT_TARGET $QT_VERSION $QT_ARCH \
          -m "https://download.qt.io/online/qtsdkrepository/$QT_HOST/$QT_TARGET/qt5_5152_modules.7z" \
          --autodesktop \
          --outputdir ${{ github.workspace }}/Qt
        
        # 安装额外模块
        aqt install-tool $QT_HOST $QT_TARGET tools_openssl
        
        # 设置环境变量
        echo "QT_ROOT=${{ github.workspace }}/Qt/$QT_VERSION/$QT_ARCH" >> $GITHUB_ENV
        echo "PATH=${{ github.workspace }}/Qt/Tools/Ninja:$PATH" >> $GITHUB_ENV

    - name: Configure Android NDK
      run: |
        $ANDROID_HOME/tools/bin/sdkmanager "ndk;${{ env.NDK_VERSION }}"
        echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV

    - name: Build preparation
      run: |
        # 生成 qmake 配置
        $QT_ROOT/bin/qmake -query
        $QT_ROOT/bin/qmake -spec android-clang CONFIG+=release
        
        # 创建必要符号链接
        ln -sf $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64 $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux

    - name: Compile project
      run: |
        make -j$(nproc)
        make apk_install_target

    - name: Build APK
      working-directory: android-build
      run: |
        chmod +x gradlew
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=../android.keystore \
          -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
          -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
          -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }} \
          --no-daemon

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qt-android-apk
        path: |
          android-build/build/outputs/apk/**/*.apk
          android-build/build/outputs/native-debug-symbols/**/*.zip
        retention-days: 7
