name: Android Qt 5.15.2 Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  QT_VERSION: 5.15.2
  ANDROID_API: android-30     # 必须升级到 API 30 以获得兼容性
  NDK_VERSION: r21e           # Qt 5.15 官方验证的 NDK 版本
  QT_HOST: linux
  QT_TARGET: android
  QT_ARCH: arm64_v8a          # 修正架构标识符
  BUILD_TOOLS_VERSION: 30.0.3 # 匹配 API 30
  ANDROID_SDK_ROOT: /opt/android-sdk  # 关键修复：提前定义路径

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'zulu'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libssl-dev

    - name: Install aqtinstall (specific version)
      run: pip install aqtinstall==2.0.6

    - name: Install Qt and Android components
      run: |
        # 创建 SDK 安装目录（关键！）
        sudo mkdir -p ${{ env.ANDROID_SDK_ROOT }}
        sudo chmod 777 ${{ env.ANDROID_SDK_ROOT }}
      
        # 安装 Android 版本的 Qt
        aqt install-qt ${{ env.QT_HOST }} ${{ env.QT_TARGET }} ${{ env.QT_VERSION }} \
          --arch ${{ env.QT_ARCH }} \
          --outputdir /opt/qt \
          --modules qtbase qttools qtsvg qtcharts

        # 安装 Android SDK/NDK
        aqt install-tool ${{ env.QT_HOST }} ${{ env.QT_TARGET }} \
          --rootdir ${{ env.ANDROID_SDK_ROOT }} platform-tools
        aqt install-tool ${{ env.QT_HOST }} ${{ env.QT_TARGET }} \
          --rootdir ${{ env.ANDROID_SDK_ROOT }} platform ${{ env.ANDROID_API }}
        aqt install-tool ${{ env.QT_HOST }} ${{ env.QT_TARGET }} \
          --rootdir ${{ env.ANDROID_SDK_ROOT }} ndk ${{ env.NDK_VERSION }}
        aqt install-tool ${{ env.QT_HOST }} ${{ env.QT_TARGET }} \
          --rootdir ${{ env.ANDROID_SDK_ROOT }} build-tools ${{ env.BUILD_TOOLS_VERSION }}

    - name: Setup environment
      run: |
        echo "ANDROID_NDK_ROOT=${{ env.ANDROID_SDK_ROOT }}/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
        echo "PATH=$PATH:/opt/qt/${{ env.QT_VERSION }}/android_${{ env.QT_ARCH }}/bin" >> $GITHUB_ENV

    - name: Generate release keystore
      run: |
        keytool -genkey -v -keystore release.keystore \
          -storepass android -alias androiddebugkey \
          -keypass android -dname "CN=, OU=, O=, L=, S=, C=" \
          -keyalg RSA -keysize 2048 -validity 10000

    - name: Build project
      run: |
        mkdir build
        cd build
        qmake ../Knot.pro -spec android-clang ANDROID_ABIS=arm64-v8a
        make -j2
        make apk

    - name: Sign APK
      env:
        RELEASE_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        KEYSTORE_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASS: ${{ secrets.KEY_PASSWORD }}
      run: |
        if [ -n "$RELEASE_KEYSTORE" ]; then
          echo "Signing with release keystore"
          echo "$RELEASE_KEYSTORE" | base64 -d > release.keystore
          find build -name '*.apk' | while read apk; do
            jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 \
              -keystore release.keystore \
              -storepass "$KEYSTORE_PASS" \
              -keypass "$KEY_PASS" \
              "$apk" \
              "$KEY_ALIAS"
          done
        else
          echo "Signing with debug keystore"
          find build -name '*.apk' | while read apk; do
            jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 \
              -keystore debug.keystore \
              -storepass android \
              -keypass android \
              "$apk" \
              androiddebugkey
          done
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: Android-APK-5.12
        path: |
          build/android-build/build/outputs/apk/debug/*.apk
          build/android-build/build/outputs/apk/release/*.apk
