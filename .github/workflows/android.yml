name: Qt Android CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Qt with required modules
      run: |
        sudo pip install aqtinstall
        aqt install-qt linux android 5.15.2 -O "$HOME/Qt" \
          --archives \
          qtbase \
          qtcharts \
          qtsensors \
          qtwebview \
          qtpositioning \
          qtlocation \
          qtsvg \
          qtandroidextras \
          qtdeclarative \
          qttools

    - name: Setup Android SDK
      run: |
        export ANDROID_SDK_ROOT="$HOME/android-sdk"
        mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
        
        wget https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip
        unzip commandlinetools-linux-*.zip -d temp
        mv temp/cmdline-tools/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
        rm -rf temp
        
        echo "JAVA_HOME=$JAVA_HOME_17_X64" >> $GITHUB_ENV
        echo "$JAVA_HOME_17_X64/bin" >> $GITHUB_PATH
        
        yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
        "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" "platform-tools" "platforms;android-33" "build-tools;33.0.0"

    - name: Install Android NDK
      run: |
        mkdir -p "$HOME/android-ndk"
        wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip android-ndk-r25c-linux.zip -d "$HOME/android-ndk"
        
        NDK_PATH="$HOME/android-ndk/android-ndk-r25c"
        echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
        echo "$NDK_PATH" >> $GITHUB_PATH

    - name: Verify Qt installation
      run: |
        echo "Installed Qt modules:"
        ls $HOME/Qt/5.15.2/android

    - name: Build project
      run: |
        qmake -spec android-clang \
          "ANDROID_ABIS=armeabi-v7a arm64-v8a" \
          CONFIG+=release
        make -j$(nproc)
        make apk

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-build
        path: android-build/*release.apk
