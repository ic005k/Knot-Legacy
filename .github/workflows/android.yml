name: Qt Android CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      QT_VERSION: 6.7.0
      ANDROID_API_LEVEL: 33
      ANDROID_NDK_VERSION: 25b
      ANDROID_SDK_TOOLS: 9477386

    steps:
    # 检出代码（包含子模块）
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # 安装Qt for Android
    - name: Install Qt
      uses: jurplel/install-qt-action@v2
      with:
        version: ${{ env.QT_VERSION }}
        host: linux
        target: android
        arch: arm64_v8a
        modules: qtbase qtmqtt qtquick3d

    # 配置Android环境
    - name: Setup Android
      uses: android-actions/setup-android@v2
      with:
        ndk-version: ${{ env.ANDROID_NDK_VERSION }}
        sdk-platform: android-${{ env.ANDROID_API_LEVEL }}
        sdk-build-tools: 34.0.0

    # 配置环境变量
    - name: Setup environment variables
      shell: bash
      run: |
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        echo "JAVA_HOME=$JAVA_HOME_17_X64" >> $GITHUB_ENV
        echo "QT_DIR=${{ env.QT_DIR }}" >> $GITHUB_ENV

    # Qt项目编译
    - name: Build Qt Project
      shell: bash
      run: |
        # 创建构建目录
        mkdir build && cd build
        
        # 生成qmake配置
        ${{ env.QT_DIR }}/bin/qt-cmake \
          -DCMAKE_SYSTEM_NAME=Android \
          -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
          -DCMAKE_ANDROID_NDK=$ANDROID_NDK_ROOT \
          -DCMAKE_ANDROID_SDK=$ANDROID_SDK_ROOT \
          ..
        
        # 执行编译
        cmake --build . --parallel 4

    # 生成APK
    - name: Deploy Android Package
      shell: bash
      run: |
        cd build
        ${{ env.QT_DIR }}/bin/androiddeployqt \
          --input android-Knot-deployment-settings.json \
          --output android-build \
          --gradle \
          --verbose

    # 上传产物
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: qt-android-apk
        path: build/android-build/build/outputs/apk/debug/*.apk
