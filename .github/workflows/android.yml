name: Qt Android CI

on:
  push:
    branches: [ main ]

env:
  QT_VERSION: "6.7.0"
  ANDROID_API: 33
  NDK_VERSION: "25.1.8937393"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 40

    steps:
    # ----------------------------------
    # 1. 代码检出
    # ----------------------------------
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # ----------------------------------
    # 2. 安装Qt（使用直接镜像参数）
    # ----------------------------------
    - name: Install Qt with mirror
      run: |
        pip install aqtinstall==3.1.9
        aqt install-qt \
          linux android ${{ env.QT_VERSION }} \
          --outputdir /opt/qt \
          --architectures arm64_v8a \
          --modules qtbase qtmqtt \
          --mirror https://mirrors.ustc.edu.cn/qtproject

    # ----------------------------------
    # 3. 配置Android环境
    # ----------------------------------
    - name: Setup Android
      uses: android-actions/setup-android@v2
      with:
        ndk-version: ${{ env.NDK_VERSION }}
        sdk-platform: android-${{ env.ANDROID_API }}
        sdk-build-tools: "34.0.0"

    # ----------------------------------
    # 4. 环境变量配置
    # ----------------------------------
    - name: Configure environment
      shell: bash
      run: |
        echo "QT_DIR=/opt/qt/${{ env.QT_VERSION }}/android_arm64_v8a" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "PATH=$QT_DIR/bin:$PATH" >> $GITHUB_ENV

    # ----------------------------------
    # 5. 项目构建
    # ----------------------------------
    - name: Build project
      working-directory: ./android  # 根据实际项目路径调整
      run: |
        mkdir build && cd build
        qt-cmake .. \
          -DCMAKE_SYSTEM_NAME=Android \
          -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a
        cmake --build . -j4

    # ----------------------------------
    # 6. 生成APK
    # ----------------------------------
    - name: Generate APK
      working-directory: ./android/build
      run: |
        androiddeployqt \
          --input android-libKnot-deployment-settings.json \
          --output apk-output \
          --gradle

    # ----------------------------------
    # 7. 上传产物
    # ----------------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: android/build/apk-output/build/outputs/apk/debug/*.apk
